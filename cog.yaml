build:
  gpu: true
  cuda: "11.8"
  python_version: "3.9"
  run:
    # Update pip first
    - "pip install --upgrade pip setuptools wheel"
  
    # Install Matcha-TTS last
    - "git clone https://github.com/shivammehta25/Matcha-TTS.git /src/third_party/Matcha-TTS"
    - "cd /src/third_party/Matcha-TTS && pip install --no-deps ."
    - "cd /src/third_party/Matcha-TTS && pip install -r requirements.txt"
    
    # Install PyTorch and torchaudio first
    - "pip install --no-cache-dir torch==2.0.1+cu118 --extra-index-url https://download.pytorch.org/whl/cu118"
    - "pip install --no-cache-dir torchaudio==2.0.2 --extra-index-url https://download.pytorch.org/whl/cu118"
    
    # Install Pydantic v1
    - "pip install --no-cache-dir 'pydantic>=1.10.0,<2.0.0'"
    
    # Rest of the packages
    - "pip install --no-cache-dir 'numpy<2' 'setuptools>=65.5.1'"
    - "pip install --no-cache-dir transformers conformer==0.3.2"
    - "pip install --no-cache-dir deepspeed==0.14.2"
    - "pip install --no-cache-dir diffusers==0.27.2"
    - "pip install --no-cache-dir gdown==5.1.0 wget==3.2"
    - "pip install --no-cache-dir gradio==4.32.2"
    - "pip install --no-cache-dir grpcio==1.57.0 grpcio-tools==1.57.0"
    - "pip install --no-cache-dir hydra-core==1.3.2 HyperPyYAML==1.2.2"
    - "pip install --no-cache-dir inflect==7.3.1 librosa==0.10.2"
    - "pip install --no-cache-dir lightning==2.2.4 matplotlib==3.7.5"
    - "pip install --no-cache-dir modelscope==1.15.0 networkx==3.1"
    - "pip install --no-cache-dir omegaconf==2.3.0 onnx==1.16.0"
    - "pip install --no-cache-dir onnxruntime-gpu==1.16.0"
    - "pip install --no-cache-dir openai-whisper==20231117"
    - "pip install --no-cache-dir protobuf==4.25"
    - "pip install --no-cache-dir rich==13.7.1 soundfile==0.12.1"
    - "pip install --no-cache-dir tensorboard==2.14.0"
    - "pip install --no-cache-dir uvicorn==0.30.0"
    - "pip install --no-cache-dir fastapi==0.111.0 fastapi-cli==0.0.4"
    - "pip install --no-cache-dir WeTextProcessing==1.0.3"
    - "pydantic>=1.10.0,<2.0.0"  # Pin to V1

  system_packages:
    - "ffmpeg"
    - "libsox-dev"
    - "sox"
    - "git"

predict: "predict.py:Predictor"